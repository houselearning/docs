<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-Time Community Forum</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/cookiebanner.js"></script>
    <!-- Configure Tailwind for custom theme -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#4f46e5',
                        'secondary': '#8b5cf6',
                        'accent': '#a78bfa',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom scrollbar for post list */
        #posts-container::-webkit-scrollbar {
            width: 8px;
        }
        #posts-container::-webkit-scrollbar-thumb {
            background-color: #a78bfa;
            border-radius: 10px;
        }
        #posts-container::-webkit-scrollbar-track {
            background: #e5e7eb;
        }
        /* Style to hide modal */
        .modal-hidden {
            display: none;
        }
        /* Style for the 3-dot menu dropdown */
        .dropdown {
            position: relative;
            display: inline-block;
        }
        .dropdown-content {
            display: none; /* Controlled by JS click handler */
            position: absolute;
            right: 0;
            background-color: #f9f9f9;
            min-width: 160px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 10;
            border-radius: 0.5rem;
            overflow: hidden;
        }
        .dropdown-content button {
            color: #374151;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            width: 100%;
            text-align: left;
            transition: background-color 0.2s;
            font-size: 0.875rem;
        }
        .dropdown-content button:hover {
            background-color: #e5e7eb;
        }
    </style>
</head>
<body class="bg-gray-50 font-sans min-h-screen">

    <!-- Header -->
    <header class="bg-primary text-white shadow-lg">
        <div class="max-w-4xl mx-auto p-4 flex justify-between items-center">
            <h1 class="text-2xl font-extrabold tracking-tight">Real-Time Forum</h1>
            <div class="text-sm flex items-center">
                <span class="font-semibold mr-2">Signed in as:</span>
                <span id="user-info" class="font-mono text-xs bg-primary/80 p-1 rounded-md">Guest</span>
                <button id="sign-out-button" class="ml-4 px-3 py-1 bg-red-500 hover:bg-red-600 rounded-lg text-white font-medium text-sm transition duration-200 hidden">Sign Out</button>
            </div>
        </div>
    </header>

    <main class="max-w-4xl mx-auto p-4">

        <!-- New Post Form -->
        <section id="post-section" class="bg-white p-6 rounded-xl shadow-lg mb-8 border-t-4 border-accent hidden">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Create New Post</h2>
            <form id="post-form">
                <input type="text" id="post-title" required placeholder="Title (Max 50 characters)" maxlength="50"
                    class="w-full p-3 mb-3 border border-gray-300 rounded-lg focus:ring-secondary focus:border-secondary transition duration-150 shadow-sm">
                
                <div class="mb-3">
                    <select id="post-tag" required 
                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-secondary focus:border-secondary transition duration-150 shadow-sm bg-white appearance-none">
                        <option value="" disabled selected>Select a Tag *</option>
                        <!-- Tags will be populated by JS -->
                    </select>
                </div>

                <textarea id="post-content" required placeholder="What's on your mind? (Max 500 characters)" maxlength="500" rows="4"
                    class="w-full p-3 mb-4 border border-gray-300 rounded-lg focus:ring-secondary focus:border-secondary transition duration-150 shadow-sm resize-none"></textarea>
                <button type="submit" id="submit-button"
                    class="w-full bg-secondary hover:bg-accent text-white font-bold py-3 rounded-lg transition duration-300 shadow-md">
                    <span id="submit-text">Submit Post</span>
                </button>
            </form>
        </section>
        
        <!-- Call to Action when signed out -->
        <section id="auth-cta" class="bg-accent/10 p-10 rounded-xl shadow-lg mb-8 text-center hidden">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Join the Discussion!</h2>
            <p class="text-gray-600 mb-6">You must sign in or create an account to post content or view comments.</p>
            <button id="open-auth-modal" class="bg-secondary hover:bg-accent text-white font-bold py-3 px-6 rounded-lg transition duration-300 shadow-md">
                Sign In / Sign Up
            </button>
        </section>

        <!-- Search and Filter Section -->
        <section class="mb-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Recent Discussions</h2>
            
            <div class="flex flex-col sm:flex-row gap-3 mb-6">
                <!-- Search Bar -->
                <input type="text" id="search-bar" placeholder="Search by title or content..."
                    class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition shadow-sm">
                
                <!-- Tag Filter -->
                <select id="tag-filter" 
                    class="p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition shadow-sm bg-white appearance-none w-full sm:w-48">
                    <option value="All">Filter by Tag (All)</option>
                    <!-- Tag filter options will be populated by JS -->
                </select>
            </div>

            <!-- Posts Display Section -->
            <div id="loading-indicator" class="text-center text-gray-500 p-8">
                <div class="animate-spin inline-block w-8 h-8 border-4 border-primary border-t-transparent rounded-full"></div>
                <p class="mt-2">Loading posts...</p>
            </div>
            <div id="posts-container" class="space-y-6 max-h-[70vh] overflow-y-auto">
                <!-- Posts will be injected here -->
            </div>
            <p id="no-posts-message" class="text-center text-gray-500 italic p-8 hidden">No posts yet or no results found. Be the first to start a discussion!</p>
        </section>
    </main>
    
    <!-- Authentication Modal (Hidden by default, delayed appearance on sign out) -->
    <div id="auth-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 modal-hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md mx-4 transform transition-all duration-300 scale-100 relative">
            
            <!-- NEW: Close Button -->
            <button id="close-auth-modal" class="absolute top-3 right-3 text-gray-400 hover:text-gray-700 transition">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6L6 18"/><path d="M6 6l12 12"/></svg>
            </button>
            
            <h3 id="auth-title" class="text-2xl font-bold text-gray-800 mb-6 text-center">Sign In</h3>
            <div id="auth-error-message" class="text-red-600 bg-red-100 p-3 rounded-lg mb-4 hidden"></div>
            
            <form id="auth-form">
                <input type="email" id="auth-email" required placeholder="Email Address"
                    class="w-full p-3 mb-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition duration-150 shadow-sm">
                <input type="password" id="auth-password" required placeholder="Password (min 6 characters)"
                    class="w-full p-3 mb-4 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition duration-150 shadow-sm">
                
                <button type="submit" id="auth-submit-button" 
                    class="w-full bg-primary hover:bg-secondary text-white font-bold py-3 rounded-lg transition duration-300 shadow-md">
                    <span id="auth-submit-text">Sign In</span>
                </button>
            </form>
            
            <p class="text-center mt-6 text-sm">
                <button id="toggle-auth-mode" class="text-primary hover:text-secondary font-medium transition duration-150">
                    Need an account? Sign Up
                </button>
            </p>
        </div>
    </div>

    <!-- Firebase SDK Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, createUserWithEmailAndPassword, signInWithEmailAndPassword, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, Timestamp, deleteDoc, updateDoc, doc, setLogLevel, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONSTANTS AND CONFIGURATION ---
        const TAGS = ['Q&A', 'Bug', 'New Feature', 'Docs Issue', 'Comment', 'General'];
        const TAG_COLORS = {
            'Q&A': 'bg-blue-500',
            'Bug': 'bg-red-500',
            'New Feature': 'bg-green-500',
            'Docs Issue': 'bg-yellow-500',
            'Comment': 'bg-purple-500',
            'General': 'bg-gray-500'
        };

        const defaultFirebaseConfig = {
            apiKey: "AIzaSyDoXSwni65CuY1_32ZE8B1nwfQO_3VNpTw",
            authDomain: "contract-center-llc-10.firebaseapp.com",
            projectId: "contract-center-llc-10",
            storageBucket: "contract-center-llc-10.firebasestorage.app",
            messagingSenderId: "323221512767",
            appId: "1:323221512767:web:6421260f875997dbf64e8a",
        };
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : JSON.stringify(defaultFirebaseConfig));
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        let db, auth, userId = null;
        let userEmail = null;
        let isSignInMode = true;
        let authCheckTimeout; // Variable to hold the 5-second timeout ID

        // STATE FOR SEARCH AND FILTERING
        let currentSearchTerm = '';
        let currentTagFilter = 'All'; 

        // --- DOM Elements ---
        const postsContainer = document.getElementById('posts-container');
        const form = document.getElementById('post-form');
        const submitButton = document.getElementById('submit-button');
        const submitText = document.getElementById('submit-text');
        const loadingIndicator = document.getElementById('loading-indicator');
        const noPostsMessage = document.getElementById('no-posts-message');
        const postSection = document.getElementById('post-section');
        const authCta = document.getElementById('auth-cta');
        const userInfoSpan = document.getElementById('user-info');
        const signOutButton = document.getElementById('sign-out-button');
        const postTagSelect = document.getElementById('post-tag');
        const tagFilterSelect = document.getElementById('tag-filter');
        const searchBar = document.getElementById('search-bar');
        
        // Modal Elements
        const authModal = document.getElementById('auth-modal');
        const authForm = document.getElementById('auth-form');
        const authTitle = document.getElementById('auth-title');
        const authSubmitButton = document.getElementById('auth-submit-button');
        const authSubmitText = document.getElementById('auth-submit-text');
        const authErrorMessage = document.getElementById('auth-error-message');
        const toggleAuthModeButton = document.getElementById('toggle-auth-mode');
        const openAuthModalButton = document.getElementById('open-auth-modal');
        const authEmailInput = document.getElementById('auth-email');
        const authPasswordInput = document.getElementById('auth-password');
        const closeAuthModalButton = document.getElementById('close-auth-modal');

        // --- FIREBASE PATHS & HELPERS ---
        const getPostRef = (postId) => doc(db, `artifacts/${appId}/public/data/forum_posts`, postId);
        const getCommentsRef = (postId) => collection(db, `artifacts/${appId}/public/data/forum_posts/${postId}/comments`);

        // --- UTILITY FUNCTIONS ---
        function formatTimestamp(timestamp) {
            if (timestamp && timestamp.toDate) {
                return timestamp.toDate().toLocaleString('en-US', {
                    year: 'numeric', month: 'short', day: 'numeric',
                    hour: '2-digit', minute: '2-digit'
                });
            }
            return 'Just now';
        }
        
        function showTemporaryMessage(message, type) {
            const tempMsg = document.createElement('div');
            tempMsg.textContent = message;
            tempMsg.className = `fixed bottom-5 right-5 p-4 rounded-lg shadow-xl text-white font-semibold transition-opacity duration-300 z-50 ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`;
            document.body.appendChild(tempMsg);

            setTimeout(() => {
                tempMsg.style.opacity = '0';
                tempMsg.addEventListener('transitionend', () => tempMsg.remove());
            }, 3000);
        }

        function populateTagDropdowns() {
            const createOption = (tag) => `<option value="${tag}">${tag}</option>`;
            postTagSelect.insertAdjacentHTML('beforeend', TAGS.map(createOption).join(''));
            tagFilterSelect.insertAdjacentHTML('beforeend', TAGS.map(createOption).join(''));
        }

        // --- COMMENT LOGIC ---

        function renderComment(commentData) {
            const isUserComment = commentData.userId === userId;
            const displayUserName = commentData.userEmail.split('@')[0];

            const commentElement = document.createElement('div');
            commentElement.className = 'p-3 bg-gray-100 rounded-lg text-sm mb-2';
            
            commentElement.innerHTML = `
                <div class="font-medium flex justify-between items-center mb-1">
                    <span class="${isUserComment ? 'text-accent' : 'text-gray-700'}">${displayUserName}</span>
                    <span class="text-xs text-gray-500">${formatTimestamp(commentData.timestamp)}</span>
                </div>
                <p class="text-gray-800 whitespace-pre-wrap">${commentData.content}</p>
            `;
            return commentElement;
        }

        function loadComments(postId, commentsContainerElement) {
            if (!db || !userId) return;

            const commentsRef = getCommentsRef(postId);
            const q = query(commentsRef, orderBy("timestamp", "asc"));

            onSnapshot(q, (snapshot) => {
                commentsContainerElement.innerHTML = '';
                snapshot.forEach((doc) => {
                    const comment = doc.data();
                    commentsContainerElement.appendChild(renderComment(comment));
                });
            }, (error) => {
                console.error("Error listening to comments:", error);
            });
        }

        function submitComment(postId, inputElement) {
            return async (e) => {
                e.preventDefault();

                if (!userId) {
                    showTemporaryMessage("You must be signed in to comment.", 'error');
                    return;
                }

                const content = inputElement.value.trim();
                if (!content) return;

                const commentsRef = getCommentsRef(postId);
                inputElement.disabled = true;

                try {
                    await addDoc(commentsRef, {
                        content: content,
                        timestamp: Timestamp.now(),
                        userId: userId,
                        userEmail: userEmail
                    });

                    inputElement.value = '';
                } catch (error) {
                    console.error("Error submitting comment:", error);
                    showTemporaryMessage(`Failed to submit comment: ${error.message}`, 'error');
                } finally {
                    inputElement.disabled = false;
                }
            };
        }


        // --- POST MANAGEMENT (CRUD) ---

        async function deletePost(postId) {
            // Using a simple confirm prompt since complex modals require more code/state
            if (!confirm("Are you sure you want to delete this post and all its comments?")) return;
            
            try {
                await deleteDoc(getPostRef(postId));
                showTemporaryMessage("Post deleted successfully!", 'success');
            } catch (error) {
                console.error("Error deleting post:", error);
                showTemporaryMessage(`Failed to delete post: ${error.message}`, 'error');
            }
        }

        async function toggleComments(postId, currentStatus) {
            try {
                await updateDoc(getPostRef(postId), {
                    commentsDisabled: !currentStatus
                });
                showTemporaryMessage(`Comments successfully ${currentStatus ? 'enabled' : 'disabled'}!`, 'success');
            } catch (error) {
                console.error("Error toggling comments:", error);
                showTemporaryMessage(`Failed to toggle comments: ${error.message}`, 'error');
            }
        }

        function handleMenuClick(postId, isCommentsDisabled, menuButtonElement) {
            const dropdownContainer = menuButtonElement.closest('.dropdown');
            if (!dropdownContainer) return;

            const dropdownContent = dropdownContainer.querySelector('.dropdown-content');
            
            if (!dropdownContent) return;

            // Set up button actions dynamically
            dropdownContent.innerHTML = `
                <button onclick="window.gemini_deletePost('${postId}')" class="text-red-600 hover:bg-red-100">Delete Post</button>
                <button onclick="window.gemini_toggleComments('${postId}', ${isCommentsDisabled})">
                    ${isCommentsDisabled ? 'Enable Comments' : 'Disable Comments'}
                </button>
            `;
            // Temporary way to expose functions globally for onclick events in dynamically generated HTML
            window.gemini_deletePost = deletePost;
            window.gemini_toggleComments = toggleComments;

            // Simple toggle to show/hide the menu manually on button click
            dropdownContent.style.display = dropdownContent.style.display === 'block' ? 'none' : 'block';
        }


        // --- MAIN POST RENDERING AND LISTENING ---

        function renderPost(postData, postId) {
            const isUserPost = postData.userId === userId;
            const displayUserName = postData.userEmail.split('@')[0];
            const tagColor = TAG_COLORS[postData.tag] || TAG_COLORS['General'];
            const commentsDisabled = postData.commentsDisabled || false;

            const postElement = document.createElement('div');
            postElement.className = 'post bg-white p-5 rounded-xl shadow-md border-t-4 border-primary/50';
            
            postElement.innerHTML = `
                <div class="flex justify-between items-start mb-3">
                    <div class="flex-1 min-w-0">
                        <h3 class="text-xl font-bold text-gray-900 truncate">${postData.title}</h3>
                    </div>
                    
                    <div class="flex items-center space-x-3 ml-4">
                        <!-- Tag Badge -->
                        <span class="text-xs font-semibold px-3 py-1 rounded-full text-white ${tagColor} shadow-md">${postData.tag}</span>

                        <!-- Management Menu (Only for post owner) -->
                        ${isUserPost ? `
                            <div class="dropdown">
                                <button class="text-gray-500 hover:text-gray-800 p-1 rounded-full hover:bg-gray-100 transition" onclick="handleMenuClick('${postId}', ${commentsDisabled}, this)">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="1"/><circle cx="12" cy="5" r="1"/><circle cx="12" cy="19" r="1"/></svg>
                                </button>
                                <div class="dropdown-content">
                                    <!-- Content injected by JS -->
                                </div>
                            </div>
                        ` : ''}
                    </div>
                </div>

                <p class="text-gray-700 mb-4 whitespace-pre-wrap">${postData.content}</p>
                
                <div class="text-right text-xs text-gray-400 border-t pt-2 mt-2">
                    Posted by <span class="font-medium text-gray-600">${displayUserName}</span> on ${formatTimestamp(postData.timestamp)}
                </div>

                <!-- Comments Section Placeholder -->
                <div class="mt-5 pt-3 border-t border-gray-200">
                    <h4 class="text-lg font-semibold text-gray-800 mb-3">Comments (${commentsDisabled ? 'Disabled' : 'Open'})</h4>
                    <div id="comments-list-${postId}" class="comments-list space-y-2 max-h-48 overflow-y-auto pr-2">
                        <!-- Comments will be injected here -->
                    </div>
                    
                    <!-- Comment Input Form -->
                    <form id="comment-form-${postId}" class="mt-4 ${commentsDisabled || !userId ? 'hidden' : 'flex items-center space-x-2'}">
                        <input type="text" id="comment-input-${postId}" placeholder="Write a comment..." required
                            class="flex-grow p-2 border border-gray-300 rounded-lg focus:ring-accent focus:border-accent text-sm" ${commentsDisabled ? 'disabled' : ''}>
                        <button type="submit" 
                            class="bg-accent hover:bg-secondary text-white font-medium py-2 px-4 rounded-lg text-sm transition" ${commentsDisabled ? 'disabled' : ''}>
                            Send
                        </button>
                    </form>
                    ${!userId && !commentsDisabled ? '<p class="text-sm text-gray-500 mt-4 italic">Sign in to leave a comment.</p>' : ''}
                    ${commentsDisabled ? '<p class="text-sm text-red-500 mt-4 italic">Commenting is currently disabled for this post.</p>' : ''}
                </div>
            `;
            
            const commentsListElement = postElement.querySelector(`#comments-list-${postId}`);
            
            if (commentsListElement && userId) {
                loadComments(postId, commentsListElement);
            }

            const commentForm = postElement.querySelector(`#comment-form-${postId}`);
            const commentInput = postElement.querySelector(`#comment-input-${postId}`);
            if (commentForm && commentInput) {
                commentForm.addEventListener('submit', submitComment(postId, commentInput));
            }
            
            return postElement;
        }

        function loadPosts() {
            if (!db) return;

            const postsRef = collection(db, `artifacts/${appId}/public/data/forum_posts`);
            
            let q = query(postsRef, orderBy("timestamp", "desc"));
            
            if (currentTagFilter && currentTagFilter !== 'All') {
                q = query(postsRef, where('tag', '==', currentTagFilter), orderBy("timestamp", "desc"));
            }

            onSnapshot(q, (snapshot) => {
                loadingIndicator.classList.add('hidden');
                
                let filteredPosts = [];

                snapshot.forEach((doc) => {
                    const post = doc.data();
                    const postId = doc.id;
                    
                    // Apply Client-Side Text Search Filter
                    if (currentSearchTerm) {
                        const searchTermLower = currentSearchTerm.toLowerCase();
                        if (post.title.toLowerCase().includes(searchTermLower) ||
                            post.content.toLowerCase().includes(searchTermLower)) {
                            filteredPosts.push({ post, postId });
                        }
                    } else {
                        filteredPosts.push({ post, postId });
                    }
                });
                
                postsContainer.innerHTML = '';

                if (filteredPosts.length === 0) {
                    noPostsMessage.classList.remove('hidden');
                    return;
                }
                noPostsMessage.classList.add('hidden');

                filteredPosts.forEach(({ post, postId }) => {
                    postsContainer.appendChild(renderPost(post, postId));
                });

            }, (error) => {
                console.error("Error listening to posts:", error);
                loadingIndicator.innerHTML = `<p class="text-red-500">Error loading posts: ${error.message}</p>`;
            });
        }

        /**
         * Handles the submission of a new post.
         */
        async function submitPost(e) {
            e.preventDefault();

            if (!userId) {
                showTemporaryMessage("Error: You must be signed in to post.", 'error');
                return;
            }

            const title = document.getElementById('post-title').value.trim();
            const content = document.getElementById('post-content').value.trim();
            const tag = document.getElementById('post-tag').value;

            if (!title || !content || !tag) {
                showTemporaryMessage("Please fill out all fields and select a tag.", 'error');
                return;
            }

            submitButton.disabled = true;
            submitText.textContent = 'Posting...';
            submitButton.classList.add('opacity-70');

            try {
                const postsRef = collection(db, `artifacts/${appId}/public/data/forum_posts`);
                
                await addDoc(postsRef, {
                    title: title,
                    content: content,
                    tag: tag,
                    commentsDisabled: false,
                    timestamp: Timestamp.now(),
                    userId: userId,
                    userEmail: userEmail
                });

                document.getElementById('post-title').value = '';
                document.getElementById('post-content').value = '';
                document.getElementById('post-tag').value = '';
                showTemporaryMessage("Post created successfully!", 'success');

            } catch (error) {
                console.error("Error writing document: ", error);
                showTemporaryMessage(`Failed to create post: ${error.message}`, 'error');
            } finally {
                submitButton.disabled = false;
                submitText.textContent = 'Submit Post';
                submitButton.classList.remove('opacity-70');
            }
        }
        
        // --- AUTHENTICATION LOGIC ---

        function toggleAuthMode() {
            isSignInMode = !isSignInMode;
            if (isSignInMode) {
                authTitle.textContent = 'Sign In';
                authSubmitText.textContent = 'Sign In';
                toggleAuthModeButton.textContent = 'Need an account? Sign Up';
            } else {
                authTitle.textContent = 'Create Account';
                authSubmitText.textContent = 'Sign Up';
                toggleAuthModeButton.textContent = 'Already have an account? Sign In';
            }
            authErrorMessage.classList.add('hidden');
        }
        
        function closeAuthModal() {
            authModal.classList.add('modal-hidden');
            // If the user manually closes it, clear the pending timeout
            if (authCheckTimeout) {
                clearTimeout(authCheckTimeout);
                authCheckTimeout = null;
            }
        }


        async function handleAuthSubmit(e) {
            e.preventDefault();
            
            const email = authEmailInput.value;
            const password = authPasswordInput.value;

            authErrorMessage.classList.add('hidden');
            authSubmitButton.disabled = true;
            authSubmitText.textContent = isSignInMode ? 'Signing In...' : 'Signing Up...';

            try {
                if (isSignInMode) {
                    await signInWithEmailAndPassword(auth, email, password);
                } else {
                    await createUserWithEmailAndPassword(auth, email, password);
                }
                
                // onAuthStateChanged handles hiding the modal now, but we'll clear inputs.
                authEmailInput.value = '';
                authPasswordInput.value = '';
                showTemporaryMessage("Signed in successfully!", 'success');


            } catch (error) {
                console.error("Authentication error:", error);
                let message = error.message.replace('Firebase: Error (auth/', '').replace(/\)\.$/, '').replace(/-/g, ' ').toUpperCase();
                authErrorMessage.textContent = `Error: ${message}`;
                authErrorMessage.classList.remove('hidden');
            } finally {
                authSubmitButton.disabled = false;
                authSubmitText.textContent = isSignInMode ? 'Sign In' : 'Sign Up';
            }
        }

        async function handleSignOut() {
            try {
                await signOut(auth);
                showTemporaryMessage("Signed out successfully.", 'success');
            } catch (error) {
                console.error("Error signing out:", error);
                showTemporaryMessage(`Sign out failed: ${error.message}`, 'error');
            }
        }

        /**
         * Initializes Firebase and sets up authentication listener.
         */
        async function initFirebase() {
            try {
                setLogLevel('debug');
                
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                populateTagDropdowns();

                // CRITICAL FIX 1: Set persistence once at the beginning to handle session loading from cache
                await setPersistence(auth, browserLocalPersistence);

                onAuthStateChanged(auth, (user) => {
                    // CRITICAL FIX 2: Clear any pending modal display timeout immediately on state change
                    if (authCheckTimeout) {
                        clearTimeout(authCheckTimeout);
                        authCheckTimeout = null;
                    }
                    
                    if (user) {
                        // User is signed in
                        userId = user.uid;
                        userEmail = user.email || 'N/A';
                        userInfoSpan.textContent = userEmail;
                        signOutButton.classList.remove('hidden');
                        postSection.classList.remove('hidden');
                        authCta.classList.add('hidden');
                        authModal.classList.add('modal-hidden'); // Ensure modal is hidden
                    } else {
                        // User is signed out
                        userId = null;
                        userEmail = null;
                        userInfoSpan.textContent = 'Guest';
                        signOutButton.classList.add('hidden');
                        postSection.classList.add('hidden');
                        authCta.classList.remove('hidden');
                        
                        // CRITICAL FIX 3: Set a timeout to display the modal after 5 seconds (5000ms)
                        // This prevents the initial flicker and respects the user's preference.
                        authCheckTimeout = setTimeout(() => {
                            // Only show the modal if the user is STILL null after the timeout
                            if (!auth.currentUser) { 
                                authModal.classList.remove('modal-hidden');
                            }
                        }, 5000);
                    }
                    
                    // Load posts only after auth state is determined
                    loadPosts();
                });
                
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                loadingIndicator.innerHTML = `<p class="text-red-500">Initialization failed: ${error.message}</p>`;
            }
        }

        // --- Event Listeners and Initialization ---
        form.addEventListener('submit', submitPost);
        authForm.addEventListener('submit', handleAuthSubmit);
        signOutButton.addEventListener('click', handleSignOut);
        toggleAuthModeButton.addEventListener('click', toggleAuthMode);
        closeAuthModalButton.addEventListener('click', closeAuthModal); // New listener for the 'X' button
        openAuthModalButton.addEventListener('click', () => {
            isSignInMode = true;
            toggleAuthMode();
            authModal.classList.remove('modal-hidden');
        });

        // Search and Filter Handlers
        tagFilterSelect.addEventListener('change', (e) => {
            currentTagFilter = e.target.value;
            loadPosts();
        });

        searchBar.addEventListener('input', (e) => {
            currentSearchTerm = e.target.value.trim();
            loadPosts();
        });

        // Expose function globally for dynamically generated HTML (the 3-dot menu)
        window.handleMenuClick = handleMenuClick; 

        window.onload = initFirebase;
    </script>
</body>
</html>
