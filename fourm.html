<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>HouseLearning Docs | Forum (Cleaned)</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: "#4f46e5",
            secondary: "#8b5cf6",
            accent: "#a78bfa",
          },
          fontFamily: {
            sans: ["Inter", "sans-serif"],
          },
        },
      },
    };
  </script>

  <style>
    /* scrollbars */
    #posts-container::-webkit-scrollbar {
      width: 8px;
    }
    #posts-container::-webkit-scrollbar-thumb {
      background-color: #a78bfa;
      border-radius: 10px;
    }
    #posts-container::-webkit-scrollbar-track {
      background: #e5e7eb;
    }
    .modal-hidden { display: none; }
    .dropdown { position: relative; display: inline-block; }
    .dropdown-content {
      display: none;
      position: absolute;
      right: 0;
      background: #f9f9f9;
      min-width: 160px;
      box-shadow: 0 8px 16px rgba(0,0,0,.12);
      z-index: 50;
      border-radius: .5rem;
      overflow: hidden;
    }
    .dropdown-content button { width:100%; text-align:left; padding:12px 16px; font-size:0.875rem; }
    .dropdown-content button:hover { background:#e5e7eb; }
  </style>
</head>
<body class="bg-gray-50 font-sans min-h-screen">

  <!-- Header -->
  <header class="bg-primary text-white shadow-lg">
    <div class="max-w-4xl mx-auto p-4 flex justify-between items-center">
      <h1 class="text-2xl font-extrabold tracking-tight">HouseLearning Docs | Forum</h1>

      <div class="text-sm flex items-center">
        <span class="font-semibold mr-2">Signed in as:</span>
        <div id="user-menu" class="relative">
          <button id="user-menu-button" class="flex items-center focus:outline-none">
            <img id="user-avatar" src="https://robohash.org/guest.png?size=80x80&set=set3" alt="Guest avatar" class="w-8 h-8 rounded-full mr-2 bg-white/30 object-cover"/>
            <span id="user-info" class="font-mono text-xs bg-primary/80 p-1 rounded-md">Guest</span>
          </button>
          <div id="user-menu-dropdown" class="hidden absolute right-0 mt-2 w-44 bg-white text-gray-800 rounded shadow-lg z-50"></div>
        </div>
        <button id="sign-out-button" class="ml-4 px-3 py-1 bg-red-500 hover:bg-red-600 rounded-lg text-white font-medium text-sm transition duration-200 hidden">Sign Out</button>
      </div>
    </div>
  </header>

  <main class="max-w-4xl mx-auto p-4">

    <!-- Create Post -->
    <section id="post-section" class="bg-white p-6 rounded-xl shadow-lg mb-8 border-t-4 border-accent hidden">
      <h2 class="text-xl font-bold text-gray-800 mb-4">Create New Post</h2>
      <form id="post-form">
        <input id="post-title" type="text" maxlength="50" placeholder="Title (Max 50 characters)" class="w-full p-3 mb-3 border rounded-lg"/>
        <div class="mb-3">
          <select id="post-tag" required class="w-full p-3 border rounded-lg bg-white">
            <option value="" disabled selected>Select a Tag *</option>
          </select>
        </div>
        <textarea id="post-content" maxlength="500" rows="4" placeholder="What's on your mind? (Max 500 characters)" class="w-full p-3 mb-4 border rounded-lg resize-none"></textarea>
        <button id="submit-button" type="submit" class="w-full bg-secondary hover:bg-accent text-white font-bold py-3 rounded-lg">
          <span id="submit-text">Submit Post</span>
        </button>
      </form>
    </section>

    <!-- Auth CTA -->
    <section id="auth-cta" class="bg-accent/10 p-10 rounded-xl shadow-lg mb-8 text-center hidden">
      <h2 class="text-2xl font-bold text-gray-800 mb-4">Join the Discussion!</h2>
      <p class="text-gray-600 mb-6">You must sign in or create an account to post content or view comments.</p>
      <button id="open-auth-modal" class="bg-secondary hover:bg-accent text-white font-bold py-3 px-6 rounded-lg">Sign In / Sign Up</button>
    </section>

    <!-- Search/Filter -->
    <section class="mb-8">
      <h2 class="text-2xl font-bold text-gray-800 mb-4">Recent Discussions</h2>

      <div class="flex flex-col sm:flex-row gap-3 mb-6">
        <div class="flex w-full">
          <input id="search-bar" type="text" placeholder="Search by title or content..." class="flex-grow p-3 border rounded-l-lg"/>
          <button id="search-button" class="px-4 bg-primary hover:bg-secondary text-white rounded-r-lg ml-2">Search</button>
        </div>
        <select id="tag-filter" class="p-3 border rounded-lg bg-white w-full sm:w-48">
          <option value="All">Filter by Tag (All)</option>
        </select>
      </div>

      <div id="loading-indicator" class="text-center text-gray-500 p-8">
        <div class="animate-spin inline-block w-8 h-8 border-4 border-primary border-t-transparent rounded-full"></div>
        <p class="mt-2">Loading posts...</p>
      </div>

      <div id="posts-container" class="space-y-6 max-h-[70vh] overflow-y-auto"></div>

      <section id="thread-view" class="hidden fixed inset-0 z-50 bg-gray-100 overflow-auto p-6">
        <div class="max-w-4xl mx-auto">
          <div id="thread-controls" class="sticky top-4 bg-transparent z-50 flex items-center justify-between mb-4">
            <button id="thread-back" class="px-3 py-1 bg-white/90 border rounded-md text-sm shadow-sm">← Back</button>
          </div>
          <div id="thread-content" class="space-y-6"></div>
        </div>
      </section>

      <section id="profile-view" class="hidden fixed inset-0 z-60 bg-white overflow-auto p-6">
        <div class="max-w-4xl mx-auto">
          <div id="profile-controls" class="sticky top-4 bg-transparent z-50 flex items-center justify-between mb-6">
            <button id="profile-back" class="px-3 py-1 bg-white/90 border rounded-md text-sm shadow-sm">← Back</button>
          </div>
          <div id="profile-content" class="bg-white rounded-lg p-6 shadow space-y-6"></div>
        </div>
      </section>

      <p id="no-posts-message" class="text-center text-gray-500 italic p-8 hidden">No posts yet or no results found. Be the first to start a discussion!</p>
    </section>
  </main>

  <!-- Auth Modal -->
  <div id="auth-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 modal-hidden">
    <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md mx-4 relative">
      <button id="close-auth-modal" class="absolute top-3 right-3 text-gray-400 hover:text-gray-700">✕</button>
      <h3 id="auth-title" class="text-2xl font-bold text-gray-800 mb-6 text-center">Sign In</h3>
      <div id="auth-error-message" class="text-red-600 bg-red-100 p-3 rounded-lg mb-4 hidden"></div>
      <form id="auth-form">
        <input id="auth-email" type="email" placeholder="Email Address" required class="w-full p-3 mb-3 border rounded-lg"/>
        <input id="auth-password" type="password" placeholder="Password (min 6 characters)" required class="w-full p-3 mb-4 border rounded-lg"/>
        <button id="auth-submit-button" type="submit" class="w-full bg-primary hover:bg-secondary text-white font-bold py-3 rounded-lg">
          <span id="auth-submit-text">Sign In</span>
        </button>
      </form>
      <p class="text-center mt-6 text-sm">
        <button id="toggle-auth-mode" class="text-primary hover:text-secondary font-medium">Need an account? Sign Up</button>
      </p>
    </div>
  </div>

  <!-- Followers Modal -->
  <div id="followers-modal" class="fixed inset-0 bg-gray-900 bg-opacity-60 flex items-center justify-center z-60 modal-hidden" style="display:none;">
    <div class="bg-white w-full max-w-3xl mx-4 rounded-xl shadow-2xl p-6 relative">
      <button id="followers-modal-close" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800">✕</button>
      <h3 id="followers-modal-title" class="text-xl font-bold mb-4">Followers / Following</h3>
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        <div>
          <h4 class="font-semibold mb-2">Followers</h4>
          <div id="followers-list" class="max-h-64 overflow-auto space-y-2 border rounded p-3 bg-gray-50"></div>
        </div>
        <div>
          <h4 class="font-semibold mb-2">Following</h4>
          <div id="following-list" class="max-h-64 overflow-auto space-y-2 border rounded p-3 bg-gray-50"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase + App logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      signOut,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      setPersistence,
      browserLocalPersistence
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import {
      getFirestore,
      collection,
      addDoc,
      onSnapshot,
      query,
      orderBy,
      Timestamp,
      deleteDoc,
      updateDoc,
      doc,
      getDoc,
      getDocs,
      setDoc,
      where,
      arrayUnion,
      arrayRemove,
      increment,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // -----------------------
    // Config & state
    // -----------------------
    const TAGS = ['Q&A', 'Bug', 'New Feature', 'Docs Issue', 'Comment', 'General'];
    const TAG_COLORS = {
      'Q&A': 'bg-blue-500',
      'Bug': 'bg-red-500',
      'New Feature': 'bg-green-500',
      'Docs Issue': 'bg-yellow-500',
      'Comment': 'bg-purple-500',
      'General': 'bg-gray-500'
    };

    const defaultFirebaseConfig = {
      apiKey: "AIzaSyDoXSwni65CuY1_32ZE8B1nwfQO_3VNpTw",
      authDomain: "contract-center-llc-10.firebaseapp.com",
      projectId: "contract-center-llc-10",
      storageBucket: "contract-center-llc-10.firebasestorage.app",
      messagingSenderId: "323221512767",
      appId: "1:323221512767:web:6421260f875997dbf64e8a",
    };
    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : JSON.stringify(defaultFirebaseConfig));
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

    let db, auth;
    let userId = null;
    let userEmail = null;
    let isSignInMode = true;
    let authCheckTimeout = null;

    // search/filter state
    let currentSearchTerm = '';
    let currentTagFilter = 'All';

    // -----------------------
    // DOM refs
    // -----------------------
    const postsContainer = document.getElementById('posts-container');
    const postSection = document.getElementById('post-section');
    const authCta = document.getElementById('auth-cta');
    const userInfoSpan = document.getElementById('user-info');
    const signOutButton = document.getElementById('sign-out-button');
    const postTagSelect = document.getElementById('post-tag');
    const tagFilterSelect = document.getElementById('tag-filter');
    const searchBar = document.getElementById('search-bar');
    const searchButton = document.getElementById('search-button');
    const loadingIndicator = document.getElementById('loading-indicator');
    const noPostsMessage = document.getElementById('no-posts-message');

    // auth modal
    const authModal = document.getElementById('auth-modal');
    const authForm = document.getElementById('auth-form');
    const authTitle = document.getElementById('auth-title');
    const authSubmitButton = document.getElementById('auth-submit-button');
    const authSubmitText = document.getElementById('auth-submit-text');
    const authErrorMessage = document.getElementById('auth-error-message');
    const toggleAuthModeButton = document.getElementById('toggle-auth-mode');
    const openAuthModalButton = document.getElementById('open-auth-modal');
    const authEmailInput = document.getElementById('auth-email');
    const authPasswordInput = document.getElementById('auth-password');
    const closeAuthModalButton = document.getElementById('close-auth-modal');

    // user menu
    const userMenuButton = document.getElementById('user-menu-button');
    const userMenuDropdown = document.getElementById('user-menu-dropdown');
    const userAvatar = document.getElementById('user-avatar');

    // profile & thread
    const profileView = document.getElementById('profile-view');
    const profileContent = document.getElementById('profile-content');
    const profileBackBtn = document.getElementById('profile-back');
    const threadView = document.getElementById('thread-view');
    const threadContent = document.getElementById('thread-content');
    const threadBackBtn = document.getElementById('thread-back');

    // followers modal
    const followersModal = document.getElementById('followers-modal');
    const followersListEl = document.getElementById('followers-list');
    const followingListEl = document.getElementById('following-list');
    const followersModalCloseBtn = document.getElementById('followers-modal-close');

    // -----------------------
    // Helpers: Firestore refs
    // -----------------------
    const getPostRef = (postId) => doc(db, `artifacts/${appId}/public/data/forum_posts`, postId);
    const getPostsCollection = () => collection(db, `artifacts/${appId}/public/data/forum_posts`);
    const getCommentsRef = (postId) => collection(db, `artifacts/${appId}/public/data/forum_posts/${postId}/comments`);
    const getUserRef = (uid) => doc(db, `artifacts/${appId}/public/data/user_profiles`, uid);

    // -----------------------
    // Small UI helpers
    // -----------------------
    function showTemporaryMessage(message, type = 'success') {
      const temp = document.createElement('div');
      temp.textContent = message;
      temp.className = `fixed bottom-5 right-5 p-4 rounded-lg shadow-xl text-white font-semibold z-50 ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`;
      document.body.appendChild(temp);
      setTimeout(() => {
        temp.style.opacity = '0';
        temp.addEventListener('transitionend', () => temp.remove());
      }, 3000);
    }

    function formatTimestamp(timestamp) {
      if (!timestamp) return 'Just now';
      if (timestamp.toDate) {
        return timestamp.toDate().toLocaleString();
      }
      const d = new Date(timestamp);
      return isNaN(d.getTime()) ? 'Unknown' : d.toLocaleString();
    }

    function escapeHtml(s = '') {
      return String(s).replaceAll('&', '&amp;').replaceAll('<', '&lt;').replaceAll('>', '&gt;').replaceAll('"', '&quot;').replaceAll("'", '&#39;');
    }

    // -----------------------
    // Comments
    // -----------------------
    function renderComment(commentData) {
      const el = document.createElement('div');
      el.className = 'p-3 bg-gray-100 rounded-lg text-sm mb-2';
      const userName = (commentData.userEmail || 'user@x').split('@')[0];
      el.innerHTML = `
        <div class="font-medium flex justify-between items-center mb-1">
          <span class="text-gray-700">${escapeHtml(userName)}</span>
          <span class="text-xs text-gray-500">${formatTimestamp(commentData.timestamp)}</span>
        </div>
        <p class="text-gray-800 whitespace-pre-wrap">${escapeHtml(commentData.content)}</p>
      `;
      return el;
    }

    function loadComments(postId, container) {
      if (!db || !postId || !container) return;
      const q = query(getCommentsRef(postId), orderBy('timestamp', 'asc'));
      onSnapshot(q, snapshot => {
        container.innerHTML = '';
        snapshot.forEach(docSnap => {
          container.appendChild(renderComment(docSnap.data()));
        });
      }, err => console.error('Comments load error', err));
    }

    function submitComment(postId, inputEl) {
      return async (e) => {
        e.preventDefault();
        if (!userId) { showTemporaryMessage('Sign in to comment', 'error'); return; }
        const text = (inputEl.value || '').trim();
        if (!text) return;
        const ref = getCommentsRef(postId);
        inputEl.disabled = true;
        try {
          await addDoc(ref, { content: text, timestamp: Timestamp.now(), userId, userEmail });
          inputEl.value = '';
        } catch (err) {
          console.error('Failed to add comment', err);
          showTemporaryMessage('Failed to add comment', 'error');
        } finally { inputEl.disabled = false; }
      };
    }

    // -----------------------
    // Posts: render & listen
    // -----------------------
    function renderPost(postData, postId) {
      const isUserPost = postData.userId === userId;
      const displayUserName = (postData.userEmail || 'user@x').split('@')[0];
      const tagColor = TAG_COLORS[postData.tag] || TAG_COLORS['General'];
      const commentsDisabled = !!postData.commentsDisabled;

      const postEl = document.createElement('div');
      postEl.className = 'post bg-white p-5 rounded-xl shadow-md border-t-4 border-primary/50';

      postEl.innerHTML = `
        <div class="flex justify-between items-start mb-3">
          <div class="flex-1 min-w-0">
            <h3 class="text-xl font-bold text-gray-900 truncate">
              <a href="#post:${postId}" class="hover:underline post-link">${escapeHtml(postData.title)}</a>
            </h3>
          </div>
          <div class="flex items-center space-x-3 ml-4">
            <span class="text-xs font-semibold px-3 py-1 rounded-full text-white ${tagColor} shadow-md">${escapeHtml(postData.tag)}</span>
            ${isUserPost ? `
            <div class="dropdown">
              <button class="text-gray-500 hover:text-gray-800 p-1 rounded-full hover:bg-gray-100 transition menu-btn">•••</button>
              <div class="dropdown-content">
                <button data-action="delete">Delete Post</button>
                <button data-action="toggle-comments">${commentsDisabled ? 'Enable Comments' : 'Disable Comments'}</button>
              </div>
            </div>` : ''}
          </div>
        </div>

        <p class="text-gray-700 mb-4 whitespace-pre-wrap">${escapeHtml(postData.content)}</p>

        <div class="text-right text-xs text-gray-400 border-t pt-2 mt-2">
          Posted by <a href="#" class="font-medium text-gray-600 hover:underline poster-link">${escapeHtml(displayUserName)}</a> on ${formatTimestamp(postData.timestamp)}
        </div>

        <div class="mt-5 pt-3 border-t border-gray-200">
          <h4 class="text-lg font-semibold text-gray-800 mb-3">Comments (${commentsDisabled ? 'Disabled' : 'Open'})</h4>
          <div class="comments-list space-y-2 max-h-48 overflow-y-auto pr-2" style="min-height:24px"></div>

          <form class="mt-4 comment-form ${commentsDisabled || !userId ? 'hidden' : 'flex items-center space-x-2'}">
            <input type="text" placeholder="Write a comment..." required class="flex-grow p-2 border rounded-lg text-sm comment-input" ${commentsDisabled ? 'disabled' : ''}/>
            <button type="submit" class="bg-accent hover:bg-secondary text-white font-medium py-2 px-4 rounded-lg text-sm" ${commentsDisabled ? 'disabled' : ''}>Send</button>
          </form>

          ${!userId && !commentsDisabled ? '<p class="text-sm text-gray-500 mt-4 italic">Sign in to leave a comment.</p>' : ''}
          ${commentsDisabled ? '<p class="text-sm text-red-500 mt-4 italic">Commenting is currently disabled for this post.</p>' : ''}
        </div>
      `;

      // attach handlers
      const postLink = postEl.querySelector('.post-link');
      if (postLink) {
        postLink.addEventListener('click', (e) => {
          e.preventDefault();
          openThread(postId);
        });
      }

      const posterLink = postEl.querySelector('.poster-link');
      if (posterLink) {
        posterLink.addEventListener('click', (e) => {
          e.preventDefault();
          openProfile(postData.userId || '', postData.userEmail || '');
        });
      }

      // menu
      const menuBtn = postEl.querySelector('.menu-btn');
      if (menuBtn) {
        const dropdown = postEl.querySelector('.dropdown-content');
        menuBtn.addEventListener('click', (ev) => {
          ev.stopPropagation();
          dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
        });
        dropdown.querySelector('[data-action="delete"]').addEventListener('click', async () => {
          if (!confirm('Delete post?')) return;
          try { await deleteDoc(getPostRef(postId)); showTemporaryMessage('Post deleted','success'); }
          catch (err) { console.error(err); showTemporaryMessage('Delete failed','error'); }
        });
        dropdown.querySelector('[data-action="toggle-comments"]').addEventListener('click', async () => {
          try {
            await updateDoc(getPostRef(postId), { commentsDisabled: !commentsDisabled });
            showTemporaryMessage('Post updated', 'success');
          } catch (err) { console.error(err); showTemporaryMessage('Update failed','error'); }
        });
      }

      // comments container
      const commentsList = postEl.querySelector('.comments-list');
      if (commentsList && !commentsDisabled) loadComments(postId, commentsList);

      // comment form
      const commentForm = postEl.querySelector('.comment-form');
      const commentInput = postEl.querySelector('.comment-input');
      if (commentForm && commentInput) {
        commentForm.addEventListener('submit', submitComment(postId, commentInput));
      }

      return postEl;
    }

    function loadPosts() {
      if (!db) return;
      loadingIndicator.classList.remove('hidden');

      let q = query(getPostsCollection(), orderBy('timestamp', 'desc'));
      if (currentTagFilter && currentTagFilter !== 'All') {
        q = query(getPostsCollection(), where('tag','==',currentTagFilter), orderBy('timestamp','desc'));
      }

      onSnapshot(q, snapshot => {
        loadingIndicator.classList.add('hidden');
        const items = [];
        snapshot.forEach(s => items.push({ id: s.id, data: s.data() }));
        // client search
        const filtered = currentSearchTerm ? items.filter(it => {
          const t = (it.data.title||'').toLowerCase();
          const c = (it.data.content||'').toLowerCase();
          const q = currentSearchTerm.toLowerCase();
          return t.includes(q) || c.includes(q);
        }) : items;

        postsContainer.innerHTML = '';
        if (filtered.length === 0) {
          noPostsMessage.classList.remove('hidden');
          return;
        } else {
          noPostsMessage.classList.add('hidden');
        }
        filtered.forEach(it => postsContainer.appendChild(renderPost(it.data, it.id)));
      }, err => {
        console.error('Posts listen error', err);
        loadingIndicator.innerHTML = `<p class="text-red-500">Error loading posts: ${escapeHtml(err.message)}</p>`;
      });
    }

    // -----------------------
    // Thread view
    // -----------------------
    function openThread(postId) {
      if (!postId || !db) return;
      threadContent.innerHTML = '<div class="p-6">Loading thread...</div>';
      threadView.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
      (async () => {
        try {
          const p = await getDoc(getPostRef(postId));
          if (!p.exists()) { threadContent.innerHTML = '<div class="p-6">Post not found.</div>'; return; }
          const data = p.data();
          threadContent.innerHTML = `
            <div class="bg-white p-6 rounded-lg shadow">
              <h2 class="text-2xl font-bold mb-2">${escapeHtml(data.title || '')}</h2>
              <div class="text-sm text-gray-500 mb-4">By ${escapeHtml((data.userEmail||'').split('@')[0])} • ${formatTimestamp(data.timestamp)}</div>
              <div class="prose">${escapeHtml(data.content || '')}</div>
            </div>
            <div id="thread-comments" class="mt-6"></div>
          `;
          loadComments(postId, document.getElementById('thread-comments'));
        } catch (err) {
          console.error('Failed to open thread', err);
          threadContent.innerHTML = `<div class="p-6 text-red-500">Failed to load thread.</div>`;
        }
      })();
    }

    // -----------------------
    // Follow system (clean)
    // -----------------------
    async function followUser(targetUid, targetEmail, targetProfileData = {}) {
      if (!userId || !targetUid || userId === targetUid) return false;

      const now = Timestamp.now();
      const followerEntry = {
        uid: userId,
        email: userEmail,
        displayName: auth.currentUser?.displayName || (userEmail || '').split('@')[0],
        photoURL: auth.currentUser?.photoURL || `https://robohash.org/${encodeURIComponent(userEmail||'guest')}.png?size=80x80&set=set3`,
        followedAt: now
      };
      const followingEntry = {
        uid: targetUid,
        email: targetEmail,
        displayName: targetProfileData?.displayName || (targetEmail || '').split('@')[0],
        photoURL: targetProfileData?.photoURL || `https://robohash.org/${encodeURIComponent(targetEmail||targetUid||'guest')}.png?size=80x80&set=set3`,
        followedAt: now
      };

      try {
        const targetRef = getUserRef(targetUid);
        const meRef = getUserRef(userId);

        // update target followers
        await updateDoc(targetRef, {
          followers: arrayUnion(followerEntry),
          followersCount: increment(1)
        }).catch(async (err) => {
          // if document missing, set it
          if (err && /not-found|no document/.test(String(err))) {
            await setDoc(targetRef, { followers: [followerEntry], followersCount: 1 }, { merge: true });
          } else throw err;
        });

        // update my following
        await updateDoc(meRef, {
          following: arrayUnion(followingEntry),
          followingCount: increment(1)
        }).catch(async (err) => {
          if (err && /not-found|no document/.test(String(err))) {
            await setDoc(meRef, { following: [followingEntry], followingCount: 1 }, { merge: true });
          } else throw err;
        });

        return true;
      } catch (err) {
        console.error('Follow failed', err);
        return false;
      }
    }

    async function unfollowUser(targetUid, targetEmail, targetProfileData = {}) {
      if (!userId || !targetUid || userId === targetUid) return false;
      try {
        const targetRef = getUserRef(targetUid);
        const meRef = getUserRef(userId);

        await updateDoc(targetRef, {
          followers: arrayRemove({ uid: userId, email: userEmail }),
          followersCount: increment(-1)
        }).catch(() => {
          // fallback: set smaller count
          // don't throw
        });

        await updateDoc(meRef, {
          following: arrayRemove({ uid: targetUid, email: targetEmail }),
          followingCount: increment(-1)
        }).catch(() => {});

        return true;
      } catch (err) {
        console.error('Unfollow failed', err);
        return false;
      }
    }

    // Setup follow button UI (idempotent)
    function setupFollowButton(profileUserId, profileEmail, profileDocData = {}) {
  const btn = document.getElementById('profile-follow');
  if (!btn) return;

  // currently logged-in user
  const currentUserId = firebase.auth().currentUser?.uid;

  let isFollowing = Array.isArray(profileDocData?.followers)
    ? profileDocData.followers.some(f => f.uid === currentUserId)
    : false;

  function updateUi() {
    btn.textContent = isFollowing ? 'Following' : '+ Follow';
    btn.classList.toggle('bg-secondary', !isFollowing);
    btn.classList.toggle('bg-gray-300', isFollowing);
  }

  updateUi();

  btn.onclick = async () => {
    if (!currentUserId) {
      showTemporaryMessage('Sign in to follow users', 'error');
      return;
    }

    btn.disabled = true;
    try {
      const userRef = firebase.firestore()
        .collection('artifacts')
        .doc('YOUR_APP_ID')        // replace with your appId
        .collection('public')
        .doc('data')
        .collection('user_profiles')
        .doc(profileUserId);

      if (isFollowing) {
        // remove follower
        await userRef.update({
          followers: firebase.firestore.FieldValue.arrayRemove({ uid: currentUserId, email: profileEmail }),
          followersCount: firebase.firestore.FieldValue.increment(-1)
        });
        isFollowing = false;
      } else {
        // add follower
        await userRef.update({
          followers: firebase.firestore.FieldValue.arrayUnion({ uid: currentUserId, email: profileEmail }),
          followersCount: firebase.firestore.FieldValue.increment(1)
        });
        isFollowing = true;
      }
      updateUi();
    } catch (err) {
      console.error('Follow action failed', err);
      showTemporaryMessage('Action failed', 'error');
    } finally {
      btn.disabled = false;
    }
  };
}


    // -----------------------
    // Followers modal rendering
    // -----------------------
    function renderPersonEntry(person) {
      const name = person?.displayName || (person?.email || person?.uid || 'Unknown').split('@')[0];
      const avatar = person?.photoURL || `https://robohash.org/${encodeURIComponent(person?.email || person?.uid || 'guest')}.png?size=80x80&set=set3`;
      const el = document.createElement('div');
      el.className = 'p-2 rounded hover:bg-white cursor-pointer flex items-center gap-3';
      el.innerHTML = `<img src="${avatar}" class="w-8 h-8 rounded-full border object-cover"/><div class="flex-1"><div class="font-medium text-sm">${escapeHtml(name)}</div><div class="text-xs text-gray-500">${escapeHtml(person?.email || person?.uid || '')}</div></div>`;
      el.addEventListener('click', () => {
        openProfile(person?.uid || '', person?.email || '');
        closeFollowersDialog();
      });
      return el;
    }

    function openFollowersDialog(profileUserId, profileDocData = {}, focus = 'followers') {
      if (!followersModal) return;
      followersListEl.innerHTML = '';
      followingListEl.innerHTML = '';

      const followersArr = Array.isArray(profileDocData?.followers) ? profileDocData.followers.slice() : [];
      const followingArr = Array.isArray(profileDocData?.following) ? profileDocData.following.slice() : [];

      const normalizeTime = it => {
        if (!it) return 0;
        if (it.seconds) return it.seconds * 1000 + (it.nanoseconds || 0) / 1e6;
        const t = Date.parse(it);
        return isNaN(t) ? (Number(it) || 0) : t;
      };

      followersArr.sort((a, b) => normalizeTime(a.followedAt) - normalizeTime(b.followedAt));
      followingArr.sort((a, b) => normalizeTime(a.followedAt) - normalizeTime(b.followedAt));

      if (followersArr.length === 0) followersListEl.innerHTML = '<div class="text-sm text-gray-500">No followers to display.</div>';
      else followersArr.forEach(p => followersListEl.appendChild(renderPersonEntry(p)));

      if (followingArr.length === 0) followingListEl.innerHTML = '<div class="text-sm text-gray-500">Not following anyone yet.</div>';
      else followingArr.forEach(p => followingListEl.appendChild(renderPersonEntry(p)));

      followersModal.style.display = 'flex';
      followersModal.classList.remove('modal-hidden');
      if (focus === 'following') followingListEl.scrollTop = 0; else followersListEl.scrollTop = 0;
    }

    function closeFollowersDialog() {
      if (!followersModal) return;
      followersModal.style.display = 'none';
      followersModal.classList.add('modal-hidden');
    }

    // -----------------------
    // Profile rendering (clean)
    // -----------------------
    async function openProfile(profileUserId, profileEmail) {
      if (!db) return;
      profileContent.innerHTML = `<div class="p-6">Loading profile...</div>`;

      try { location.hash = `user:${profileUserId || profileEmail}`; } catch(_) {}

      profileView.classList.remove('hidden');
      document.body.style.overflow = 'hidden';

      let profileDocData = null;
      try {
        if (profileUserId) {
          const udoc = await getDoc(getUserRef(profileUserId));
          if (udoc.exists()) profileDocData = udoc.data();
        }
      } catch (err) {
        console.warn('Profile document fetch failed:', err);
      }

      if (profileUserId) {
        const local = loadProfileLocal(profileUserId);
        if (local) {
          profileDocData = Object.assign({}, profileDocData || {}, local);
          profileDocData._localOverride = true;
        }
      }

      const displayName = (profileEmail || 'user@unknown').split('@')[0];
      const fullName = profileDocData?.displayName || displayName;
      const bio = profileDocData?.bio || '';
      const avatarSrc = profileDocData?.photoURL || `https://robohash.org/${encodeURIComponent(profileEmail || profileUserId || 'guest')}.png?size=200x200&set=set3`;
      const joinDate = profileDocData?.joinDate ? new Date(profileDocData.joinDate).toLocaleDateString() : 'Unknown';
      const followersCount = profileDocData?.followersCount ?? (Array.isArray(profileDocData?.followers) ? profileDocData.followers.length : 0);
      const followingCount = profileDocData?.followingCount ?? (Array.isArray(profileDocData?.following) ? profileDocData.following.length : 0);
      const isOwn = userId && profileUserId && userId === profileUserId;

      profileContent.innerHTML = `
        <div class="flex flex-col sm:flex-row gap-6">
          <div class="w-full sm:w-1/3 flex flex-col items-center">
            <img id="profile-avatar-img" src="${avatarSrc}" alt="${escapeHtml(fullName)} avatar" class="w-40 h-40 rounded-full object-cover mb-4 border">
            <div class="text-center">
              <div id="profile-fullname" class="text-xl font-bold">${escapeHtml(fullName)}</div>
              <div id="profile-email" class="text-sm text-gray-500">${escapeHtml(profileEmail || '')}</div>
              <div id="profile-joined" class="text-xs text-gray-400 mt-2">Joined: ${escapeHtml(joinDate)}</div>
            </div>
            <div class="mt-4 w-full flex flex-col gap-2">
              ${isOwn ? '<button id="profile-edit" class="px-4 py-2 bg-primary text-white rounded">Edit profile</button>' : '<button id="profile-follow" class="px-4 py-2 bg-secondary text-white rounded">+ Follow</button>'}
            </div>
          </div>
          <div class="w-full sm:w-2/3">
            <div id="profile-bio" class="text-sm text-gray-600 mb-4">${escapeHtml(bio)}</div>
            <div class="flex gap-6 mb-4 text-sm">
              <div><button id="profile-following-count-btn" class="font-semibold text-left">${escapeHtml(String(followingCount))}</button> Following</div>
              <div><button id="profile-followers-count-btn" class="font-semibold text-left">${escapeHtml(String(followersCount))}</button> Followers</div>
            </div>
            <hr class="mb-4">
            <h3 class="text-lg font-bold mb-3">Recent Threads</h3>
            <div id="profile-threads" class="space-y-4"></div>
          </div>
        </div>
      `;

      // Now DOM exists — wire up elements
      const followBtn = document.getElementById('profile-follow');
      const followersBtn = document.getElementById('profile-followers-count-btn');
      const followingBtn = document.getElementById('profile-following-count-btn');
      const editBtn = document.getElementById('profile-edit');

      if (followBtn) setupFollowButton(profileUserId, profileEmail, profileDocData);

      if (followersBtn) followersBtn.addEventListener('click', () => openFollowersDialog(profileUserId, profileDocData, 'followers'));
      if (followingBtn) followingBtn.addEventListener('click', () => openFollowersDialog(profileUserId, profileDocData, 'following'));
      if (editBtn) editBtn.addEventListener('click', () => showProfileEdit(profileUserId, profileEmail, profileDocData || {}));

      renderProfileThreads(profileUserId, profileEmail);
    }

    function closeProfile() {
      if (location.hash && location.hash.startsWith('#user:')) history.pushState('', document.title, window.location.pathname + window.location.search);
      profileView.classList.add('hidden');
      profileContent.innerHTML = '';
      document.body.style.overflow = '';
    }

    // Render profile threads
    async function renderProfileThreads(profileUserId, profileEmail) {
      const container = document.getElementById('profile-threads');
      if (!container) return;
      container.innerHTML = '<div class="text-sm text-gray-500">Loading threads...</div>';
      try {
        const postsRef = getPostsCollection();
        let q;
        if (profileUserId) q = query(postsRef, where('userId','==',profileUserId), orderBy('timestamp','desc'));
        else if (profileEmail) q = query(postsRef, where('userEmail','==',profileEmail), orderBy('timestamp','desc'));
        else { container.innerHTML = '<div class="text-sm text-gray-500">No threads found.</div>'; return; }
        const snapshot = await getDocs(q);
        container.innerHTML = '';
        if (snapshot.empty) { container.innerHTML = '<div class="text-sm text-gray-500">No threads yet.</div>'; return; }
        snapshot.forEach(docSnap => {
          const p = docSnap.data();
          const tid = docSnap.id;
          const el = document.createElement('div');
          el.className = 'p-3 bg-white rounded border hover:bg-gray-50';
          el.innerHTML = `<a href="#post:${tid}" class="font-medium text-primary hover:underline">${escapeHtml(p.title||'')}</a><div class="text-xs text-gray-500 mt-1">${escapeHtml(p.tag||'')} • ${formatTimestamp(p.timestamp)}</div>`;
          el.querySelector('a').addEventListener('click', (ev) => { ev.preventDefault(); openThread(tid); });
          container.appendChild(el);
        });
      } catch (err) {
        console.error('Error loading profile threads:', err);
        container.innerHTML = `<div class="text-sm text-red-500">Failed to load threads.</div>`;
      }
    }

    // Show inline profile edit
    function showProfileEdit(profileUserId, profileEmail, existing = {}) {
      const content = profileContent;
      if (!content) return;
      const currentName = existing.displayName || (profileEmail||'').split('@')[0];
      const currentBio = existing.bio || '';
      const currentPhoto = existing.photoURL || '';
      content.innerHTML = `
        <div class="space-y-4">
          <div class="flex gap-4">
            <img src="${currentPhoto || `https://robohash.org/${encodeURIComponent(profileEmail || profileUserId || 'guest')}.png?size=200x200&set=set3`}" alt="avatar" class="w-28 h-28 rounded-full object-cover">
            <div class="flex-1">
              <label class="block text-sm font-medium">Full name</label>
              <input id="edit-displayName" class="w-full border rounded p-2" value="${escapeHtml(currentName)}"/>
              <label class="block text-sm font-medium mt-3">Photo URL</label>
              <input id="edit-photoURL" class="w-full border rounded p-2" value="${escapeHtml(currentPhoto)}"/>
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium">Bio</label>
            <textarea id="edit-bio" class="w-full border rounded p-2" rows="4">${escapeHtml(currentBio)}</textarea>
          </div>
          <div class="flex gap-2">
            <button id="edit-save" class="px-4 py-2 bg-primary text-white rounded">Save</button>
            <button id="edit-cancel" class="px-4 py-2 bg-gray-200 rounded">Cancel</button>
          </div>
        </div>
      `;

      document.getElementById('edit-cancel').addEventListener('click', () => openProfile(profileUserId, profileEmail));

      document.getElementById('edit-save').addEventListener('click', async () => {
        if (!userId || userId !== profileUserId) { alert('You can only edit your own profile.'); return; }
        const newName = document.getElementById('edit-displayName').value.trim();
        const newBio = document.getElementById('edit-bio').value.trim();
        const newPhoto = document.getElementById('edit-photoURL').value.trim();
        try {
          await updateDoc(getUserRef(profileUserId), { displayName: newName, bio: newBio, photoURL: newPhoto, joinDate: existing.joinDate || serverTimestamp() });
          showTemporaryMessage('Profile updated','success');
          openProfile(profileUserId, profileEmail);
        } catch (err) {
          console.error('Failed to save profile:', err);
          showTemporaryMessage('Failed to save profile','error');
          // fallback local save on permission denied
          if (err && (err.code === 'permission-denied' || /permission/i.test(String(err)))) {
            saveProfileLocal(profileUserId, { displayName: newName, bio: newBio, photoURL: newPhoto, joinDate: existing.joinDate || new Date().toISOString() });
            openProfile(profileUserId, profileEmail);
            showTemporaryMessage('Saved locally (server denied write).','success');
          }
        }
      });
    }

    // local profile fallback helpers
    function saveProfileLocal(uid, data) { try { localStorage.setItem(`local_profile_${uid}`, JSON.stringify(data)); } catch(e){console.warn(e);} }
    function loadProfileLocal(uid) { try { const raw = localStorage.getItem(`local_profile_${uid}`); return raw ? JSON.parse(raw) : null; } catch(e){ return null; } }

    // -----------------------
    // Auth handling
    // -----------------------
    async function handleAuthSubmit(e) {
      e.preventDefault();
      const email = authEmailInput.value;
      const password = authPasswordInput.value;
      authErrorMessage.classList.add('hidden');
      authSubmitButton.disabled = true;
      authSubmitText.textContent = isSignInMode ? 'Signing In...' : 'Signing Up...';
      try {
        if (isSignInMode) await signInWithEmailAndPassword(auth, email, password);
        else await createUserWithEmailAndPassword(auth, email, password);
        closeAuthModal();
        authEmailInput.value = '';
        authPasswordInput.value = '';
        showTemporaryMessage('Signed in successfully','success');
      } catch (err) {
        console.error('Authentication error', err);
        authErrorMessage.textContent = `Error: ${String(err.message || err)}`;
        authErrorMessage.classList.remove('hidden');
      } finally {
        authSubmitButton.disabled = false;
        authSubmitText.textContent = isSignInMode ? 'Sign In' : 'Sign Up';
      }
    }

    function toggleAuthMode() {
      isSignInMode = !isSignInMode;
      if (isSignInMode) { authTitle.textContent = 'Sign In'; authSubmitText.textContent = 'Sign In'; toggleAuthModeButton.textContent = 'Need an account? Sign Up'; }
      else { authTitle.textContent = 'Create Account'; authSubmitText.textContent = 'Sign Up'; toggleAuthModeButton.textContent = 'Already have an account? Sign In'; }
      authErrorMessage.classList.add('hidden');
    }

    function closeAuthModal() {
      authModal.classList.add('modal-hidden');
      authModal.style.display = 'none';
      if (authCheckTimeout) { clearTimeout(authCheckTimeout); authCheckTimeout = null; }
    }

    // -----------------------
    // Init Firebase & bindings
    // -----------------------
    async function initFirebase() {
      try {
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);

        // populate tags
        TAGS.forEach(tag => postTagSelect.insertAdjacentHTML('beforeend', `<option value="${tag}">${tag}</option>`));
        TAGS.forEach(tag => tagFilterSelect.insertAdjacentHTML('beforeend', `<option value="${tag}">${tag}</option>`));

        await setPersistence(auth, browserLocalPersistence);

        onAuthStateChanged(auth, (user) => {
          if (authCheckTimeout) { clearTimeout(authCheckTimeout); authCheckTimeout = null; }

          if (user) {
            userId = user.uid;
            userEmail = user.email || '';
            userInfoSpan.textContent = userEmail;
            signOutButton.classList.remove('hidden');
            postSection.classList.remove('hidden');
            authCta.classList.add('hidden');
            authModal.classList.add('modal-hidden'); authModal.style.display = 'none';
            userAvatar.src = user.photoURL || `https://robohash.org/${encodeURIComponent(userEmail||userId||'guest')}.png?size=80x80&set=set3`;
            userAvatar.alt = `${(user.email||'user').split('@')[0]}'s avatar`;
          } else {
            userId = null; userEmail = null;
            userInfoSpan.textContent = 'Guest';
            signOutButton.classList.add('hidden');
            postSection.classList.add('hidden');
            authCta.classList.remove('hidden');
            userAvatar.src = 'https://robohash.org/guest.png?size=80x80&set=set3';
            // delay showing modal to avoid flicker
            authCheckTimeout = setTimeout(() => {
              if (!auth.currentUser) { authModal.classList.remove('modal-hidden'); authModal.style.display = 'flex'; }
            }, 5000);
          }

          updateUserMenu();
          loadPosts();
        });

      } catch (err) {
        console.error('Firebase init failed', err);
        loadingIndicator.innerHTML = `<p class="text-red-500">Init failed: ${escapeHtml(String(err.message||err))}</p>`;
      }

      // event bindings
      document.getElementById('post-form').addEventListener('submit', submitPost);
      authForm.addEventListener('submit', handleAuthSubmit);
      signOutButton.addEventListener('click', async () => { try { await signOut(auth); showTemporaryMessage('Signed out','success'); } catch(e){showTemporaryMessage('Sign out failed','error');} });
      toggleAuthModeButton.addEventListener('click', toggleAuthMode);
      closeAuthModalButton.addEventListener('click', closeAuthModal);
      openAuthModalButton.addEventListener('click', () => { isSignInMode = true; authTitle.textContent = 'Sign In'; authSubmitText.textContent = 'Sign In'; toggleAuthModeButton.textContent = 'Need an account? Sign Up'; authModal.classList.remove('modal-hidden'); authModal.style.display = 'flex'; });

      // search & filters
      tagFilterSelect.addEventListener('change', (e) => { currentTagFilter = e.target.value; loadPosts(); });
      searchButton.addEventListener('click', () => { currentSearchTerm = (searchBar.value||'').trim(); loadPosts(); });
      searchBar.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); searchButton.click(); } });

      // user menu
      function closeUserMenu() { userMenuDropdown.classList.add('hidden'); }
      function toggleUserMenu(e) { e.stopPropagation(); userMenuDropdown.classList.toggle('hidden'); }
      userMenuButton.addEventListener('click', toggleUserMenu);
      document.addEventListener('click', closeUserMenu);

      // profile back & thread back
      if (profileBackBtn) profileBackBtn.addEventListener('click', closeProfile);
      if (threadBackBtn) threadBackBtn.addEventListener('click', () => { threadView.classList.add('hidden'); threadContent.innerHTML = ''; document.body.style.overflow = ''; });

      // followers modal close
      if (followersModalCloseBtn) followersModalCloseBtn.addEventListener('click', closeFollowersDialog);

      // build user menu dynamically in updateUserMenu
    }

    // submit new post
    async function submitPost(e) {
      e.preventDefault();
      if (!userId) { showTemporaryMessage('Sign in to post', 'error'); return; }
      const title = document.getElementById('post-title').value.trim();
      const content = document.getElementById('post-content').value.trim();
      const tag = document.getElementById('post-tag').value;
      if (!title || !content || !tag) { showTemporaryMessage('Fill all fields', 'error'); return; }

      const submitBtn = document.getElementById('submit-button');
      const submitText = document.getElementById('submit-text');
      submitBtn.disabled = true; submitText.textContent = 'Posting...';

      try {
        await addDoc(getPostsCollection(), { title, content, tag, commentsDisabled: false, timestamp: Timestamp.now(), userId, userEmail });
        document.getElementById('post-title').value = '';
        document.getElementById('post-content').value = '';
        document.getElementById('post-tag').value = '';
        showTemporaryMessage('Post created!', 'success');
      } catch (err) {
        console.error('Create post failed', err);
        showTemporaryMessage('Failed to create post', 'error');
      } finally {
        submitBtn.disabled = false; submitText.textContent = 'Submit Post';
      }
    }

    // User menu updater
    function updateUserMenu() {
      userMenuDropdown.innerHTML = '';
      if (userId) {
        userMenuDropdown.innerHTML = `
          <a href="/auth/" class="block px-4 py-2 hover:bg-gray-100">Dashboard</a>
          <a href="/docs/" class="block px-4 py-2 hover:bg-gray-100">Docs</a>
        `;
      } else {
        userMenuDropdown.innerHTML = `<button id="user-menu-signin" class="w-full text-left px-4 py-2 hover:bg-gray-100">Sign in</button>`;
        const btn = document.getElementById('user-menu-signin');
        if (btn) btn.addEventListener('click', (ev) => { ev.stopPropagation(); isSignInMode = true; authModal.classList.remove('modal-hidden'); authModal.style.display = 'flex'; });
      }
    }

    // expose some funcs for debug/links
    window.openProfile = openProfile;
    window.closeProfile = closeProfile;
    window.openThread = openThread;

    // initialize
    window.addEventListener('load', initFirebase);
  </script>
</body>
</html>
