<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HouseLearning Status Checker</title>
    <!-- Load Tailwind CSS -->
    
  <script src="https://houselearning.github.io/feedback.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/cookiebanner.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // Using a simple, clean palette
                        'hl-primary': '#10b981', // Emerald green for status/success
                        'hl-secondary': '#4f46e5', // Indigo for links/branding
                        'hl-bg': '#f9fafb', // Light grey background
                        'hl-card': '#ffffff', // White card background
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        /* Custom styles for the clean, documentation-like aesthetic */
        body {
            background-color: theme('colors.hl-bg');
            min-height: 100vh;
        }
        .sidebar {
            /* Fix the sidebar height on desktop */
            min-height: calc(100vh - 4rem);
        }
        .repo-item {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .repo-item:hover {
            background-color: theme('colors.hl-primary/10');
        }
        /* Style for the logo placeholder to ensure it looks good */
        .logo-placeholder {
            font-size: 1.5rem;
            font-weight: 700;
            color: theme('colors.hl-secondary');
        }

        /* SCROLLBAR STYLING for the Repository List */
        #repo-list::-webkit-scrollbar {
            width: 6px;
        }
        #repo-list::-webkit-scrollbar-thumb {
            background-color: theme('colors.hl-secondary/50');
            border-radius: 3px;
        }
        #repo-list::-webkit-scrollbar-thumb:hover {
            background-color: theme('colors.hl-secondary');
        }
    </style>
</head>
<body class="font-sans antialiased">

    <!-- Header / Navbar -->
    <header class="bg-hl-card shadow-md">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <div class="logo-placeholder">
                HouseLearning Status
            </div>
            <nav>
                <a href="https://houselearning.github.io" target="_blank" class="text-hl-secondary hover:text-hl-primary transition duration-150 ease-in-out font-medium">
                    Visit Main Site
                </a>
            </nav>
        </div>
    </header>

    <!-- Main Content Area -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-6">
        <div class="lg:grid lg:grid-cols-4 lg:gap-8">

            <!-- Sidebar: Repository Selector -->
            <aside class="lg:col-span-1 mb-6 lg:mb-0">
                <div class="bg-hl-card p-4 rounded-xl shadow-lg sidebar border border-gray-100">
                    <h2 class="text-lg font-semibold text-gray-800 mb-4 border-b pb-2">Repositories Status</h2>
                    <!-- SCROLLABLE CONTAINER ADDED HERE -->
                    <div id="repo-list" class="space-y-3 max-h-[70vh] overflow-y-auto pr-2">
                        <!-- Repository items will be injected here -->
                        <div class="text-sm text-gray-500 italic" id="loading-repos">
                            Loading repositories and latest commits...
                        </div>
                    </div>
                </div>
            </aside>

            <!-- Main Status Panel -->
            <main class="lg:col-span-3">
                <div class="space-y-6">

                    <!-- Website Status Card -->
                    <div class="bg-hl-card p-6 rounded-xl shadow-lg border border-gray-100">
                        <h1 class="text-2xl font-bold mb-4 text-gray-800">houselearning.github.io Service Status</h1>

                        <div id="website-status" class="flex items-center space-x-3 p-4 rounded-lg bg-gray-50 border border-gray-200">
                            <!-- Status Indicator -->
                            <span id="status-icon" class="w-4 h-4 rounded-full bg-gray-400 animate-pulse"></span>
                            <!-- Status Text -->
                            <p class="text-xl font-medium text-gray-600">
                                Status: <span id="status-text" class="font-bold">Checking...</span>
                            </p>
                        </div>

                        <p class="mt-4 text-sm text-gray-600 border-t pt-4">
                            The status is determined by a successful network request from your browser to the site. If the status is 'UP', it means the site is reachable and responding. Due to browser security restrictions (CORS), a definitive HTTP status code (like 200 OK) cannot be reliably confirmed for an external site without server-side proxying, but network connectivity is verified.
                        </p>
                    </div>

                    <!-- Selected Repo Details Card -->
                    <div id="repo-detail-card" class="bg-hl-card p-6 rounded-xl shadow-lg border border-gray-100 hidden">
                        <h2 id="repo-detail-title" class="text-2xl font-bold mb-4 text-gray-800">Repository Details</h2>
                        <div id="repo-detail-content" class="space-y-3">
                            <!-- Details will be injected here -->
                        </div>
                    </div>

                </div>
            </main>
        </div>
    </div>

    <script>
        // --- Configuration ---
        const HOUSELEARNING_ORG = 'HouseLearning';
        const WEBSITE_URL = 'https://houselearning.github.io';
        const GITHUB_API_URL = 'https://api.github.com';
        const WEBSITE_STATUS_ELEMENT = document.getElementById('website-status');
        const STATUS_TEXT = document.getElementById('status-text');
        const STATUS_ICON = document.getElementById('status-icon');
        const REPO_LIST = document.getElementById('repo-list');
        const LOADING_REPOS = document.getElementById('loading-repos');
        const REPO_DETAIL_CARD = document.getElementById('repo-detail-card');
        const REPO_DETAIL_TITLE = document.getElementById('repo-detail-title');
        const REPO_DETAIL_CONTENT = document.getElementById('repo-detail-content');

        // Store repository data globally
        let allRepositories = [];

        // --- Utility Functions ---

        /**
         * Converts ISO 8601 date string to a readable format.
         * @param {string} dateString
         * @returns {string}
         */
        function formatCommitDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                timeZoneName: 'short'
            });
        }
        
        // Removed generateMockRepositories as requested.

        // --- Core Functions ---

        /**
         * Checks the status of the main HouseLearning website.
         * Due to CORS restrictions, we use 'no-cors' mode, which only tells us if the network request completed (opaque response).
         * If the promise resolves, we assume the site is up. If it rejects (network error), we assume it's down.
         */
        async function checkWebsiteStatus() {
            STATUS_TEXT.textContent = 'Checking...';
            STATUS_ICON.classList.remove('bg-red-500', 'bg-hl-primary');
            STATUS_ICON.classList.add('bg-gray-400', 'animate-pulse');
            WEBSITE_STATUS_ELEMENT.classList.remove('bg-red-100', 'bg-green-100');
            WEBSITE_STATUS_ELEMENT.classList.add('bg-gray-50');

            try {
                // Use 'no-cors' mode to prevent the browser from blocking the request.
                const response = await fetch(WEBSITE_URL, { mode: 'no-cors', cache: 'no-store' });

                // If the fetch call resolves, the site is considered reachable ("UP").
                STATUS_TEXT.textContent = 'UP (Reachable)';
                STATUS_TEXT.classList.add('text-hl-primary');
                STATUS_ICON.classList.remove('bg-gray-400', 'animate-pulse');
                STATUS_ICON.classList.add('bg-hl-primary');
                WEBSITE_STATUS_ELEMENT.classList.remove('bg-gray-50');
                WEBSITE_STATUS_ELEMENT.classList.add('bg-green-100');
            } catch (error) {
                console.error("Website status check failed (Network/CORS issue):", error);
                // If the fetch promise rejects (e.g., DNS failure, no network), the site is considered down.
                STATUS_TEXT.textContent = 'DOWN (Unreachable)';
                STATUS_TEXT.classList.remove('text-hl-primary');
                STATUS_TEXT.classList.add('text-red-500');
                STATUS_ICON.classList.remove('bg-gray-400', 'animate-pulse');
                STATUS_ICON.classList.add('bg-red-500');
                WEBSITE_STATUS_ELEMENT.classList.remove('bg-gray-50');
                WEBSITE_STATUS_ELEMENT.classList.add('bg-red-100');
            }
        }

        /**
         * Fetches all public repositories for the organization.
         * Displays a "Limit Reached" message on 403/429 errors.
         * @returns {Promise<Array>}
         */
        async function fetchRepositories() {
            try {
                // Get list of public repositories
                const reposResponse = await fetch(`${GITHUB_API_URL}/orgs/${HOUSELEARNING_ORG}/repos?sort=pushed&per_page=100`);

                // Check for rate limit errors first
                if (reposResponse.status === 403 || reposResponse.status === 429) {
                    throw new Error(`GitHub API Error: ${reposResponse.status}. Rate limit hit.`);
                }
                
                if (!reposResponse.ok) throw new Error(`GitHub API Error: ${reposResponse.status}`);
                const repos = await reposResponse.json();

                // For each repo, fetch the latest commit
                const reposWithCommits = await Promise.all(repos.map(async (repo) => {
                    // Endpoint to get the very latest commit on the default branch
                    const commitUrl = `${GITHUB_API_URL}/repos/${HOUSELEARNING_ORG}/${repo.name}/commits?per_page=1`;
                    const commitResponse = await fetch(commitUrl);

                    let latestCommit = null;
                    if (commitResponse.ok) {
                        const commits = await commitResponse.json();
                        if (commits.length > 0) {
                            latestCommit = commits[0];
                        }
                    } else {
                        // Log warning but don't stop the whole process
                        console.warn(`Could not fetch commit for ${repo.name}. Status: ${commitResponse.status}`);
                    }

                    return {
                        name: repo.name,
                        description: repo.description,
                        html_url: repo.html_url,
                        latestCommit: latestCommit
                    };
                }));

                allRepositories = reposWithCommits;
                renderRepositories();

            } catch (error) {
                console.error("Failed to fetch repository data:", error);
                
                // Check if the error indicates a rate limit issue (403 Forbidden is common for unauthenticated limits)
                if (error.message.includes("403") || error.message.includes("429") || error.message.includes("Rate limit hit")) {
                    
                    // Clear the list area
                    REPO_LIST.innerHTML = ''; 
                    
                    // Display the "Limit Reached" message in the list area
                    REPO_LIST.innerHTML = `
                        <div class="p-4 bg-red-100 border border-red-300 rounded-lg text-red-800 text-center font-semibold mt-4">
                            <p>GitHub API Limit Reached.</p>
                            <p class="text-sm font-normal mt-1">Cannot fetch real-time data due to rate limits. Please try again later.</p>
                        </div>
                    `;
                    // Hide the detail card since there is no data
                    REPO_DETAIL_CARD.classList.add('hidden');

                    return; // Stop execution
                }

                // Generic error handling
                REPO_LIST.innerHTML = `
                    <div class="p-4 bg-red-100 border border-red-300 rounded-lg text-red-800 text-center font-semibold mt-4">
                        <p>Error loading repositories.</p>
                        <p class="text-sm font-normal mt-1">Check console for details on the network failure.</p>
                    </div>
                `;
                REPO_DETAIL_CARD.classList.add('hidden');
            }
        }

        /**
         * Renders the fetched repositories into the sidebar.
         */
        function renderRepositories() {
            // Remove the initial 'loading-repos' message if we have data
            if (document.getElementById('loading-repos')) {
                document.getElementById('loading-repos').remove();
            }
            
            REPO_LIST.innerHTML = ''; // Clear contents before re-rendering

            if (allRepositories.length === 0) {
                REPO_LIST.innerHTML = `
                    <div class="text-sm text-gray-500 italic p-2 text-center">
                        No repositories found in the organization.
                    </div>
                `;
                REPO_DETAIL_CARD.classList.add('hidden');
                return;
            }


            allRepositories.forEach(repo => {
                const latestCommitMessage = repo.latestCommit?.commit?.message.split('\n')[0] || 'No commits found.';
                const latestCommitDate = repo.latestCommit?.commit?.author?.date || null;

                const repoItem = document.createElement('div');
                repoItem.className = 'repo-item p-3 rounded-lg border-l-4 border-hl-secondary/0 hover:border-hl-secondary';
                repoItem.setAttribute('data-repo-name', repo.name);
                repoItem.innerHTML = `
                    <p class="text-sm font-semibold text-gray-900 truncate">${repo.name}</p>
                    <p class="text-xs text-gray-500 mt-1 truncate" title="${latestCommitMessage}">
                        <span class="font-medium text-gray-600">Commit:</span> ${latestCommitMessage}
                    </p>
                    <p class="text-xs text-gray-400 mt-1">
                        ${latestCommitDate ? formatCommitDate(latestCommitDate) : ''}
                    </p>
                `;

                repoItem.addEventListener('click', () => displayRepoDetails(repo.name));
                REPO_LIST.appendChild(repoItem);
            });

            // Automatically display the first repo's details if available
            if (allRepositories.length > 0) {
                displayRepoDetails(allRepositories[0].name);
            }
        }

        /**
         * Displays detailed information for a selected repository.
         * @param {string} repoName
         */
        function displayRepoDetails(repoName) {
            const repo = allRepositories.find(r => r.name === repoName);
            if (!repo) return;

            // Update sidebar highlighting
            document.querySelectorAll('.repo-item').forEach(item => {
                item.classList.remove('bg-hl-secondary/10', 'border-hl-secondary');
            });
            document.querySelector(`[data-repo-name="${repoName}"]`).classList.add('bg-hl-secondary/10', 'border-hl-secondary');

            // Populate the detail card
            const commit = repo.latestCommit;
            const commitMessage = commit?.commit?.message.split('\n')[0] || 'N/A';
            const commitAuthor = commit?.commit?.author?.name || 'N/A';
            const commitDate = commit?.commit?.author?.date ? formatCommitDate(commit.commit.author.date) : 'N/A';
            const commitSha = commit?.sha ? commit.sha.substring(0, 10) : 'N/A';

            REPO_DETAIL_TITLE.textContent = repo.name;
            REPO_DETAIL_CONTENT.innerHTML = `
                <p class="text-gray-700">${repo.description || 'No description provided.'}</p>
                
                <div class="space-y-2 pt-4 border-t mt-4 border-gray-100">
                    <p class="text-sm text-gray-500 font-medium">LATEST COMMIT</p>
                    <p class="text-md font-semibold text-gray-800 break-words">${commitMessage}</p>
                    <div class="text-sm text-gray-600 space-y-1">
                        <p><strong>Author:</strong> ${commitAuthor}</p>
                        <p><strong>Date:</strong> ${commitDate}</p>
                        <p><strong>SHA:</strong> <code class="bg-gray-200 px-1 py-0.5 rounded text-xs">${commitSha}</code></p>
                    </div>
                </div>

                <a href="${repo.html_url}" target="_blank" class="inline-block mt-4 text-sm font-medium text-white bg-hl-secondary hover:bg-hl-secondary/90 px-4 py-2 rounded-lg transition duration-150 shadow-md">
                    View Repository on GitHub &rarr;
                </a>
            `;
            REPO_DETAIL_CARD.classList.remove('hidden');
        }

        // --- Initialization ---

        window.onload = function() {
            // Start both checks immediately
            checkWebsiteStatus();
            fetchRepositories();

            // Optional: Re-check status every 60 seconds
            setInterval(checkWebsiteStatus, 60000);
        };
    </script>
</body>
</html>
